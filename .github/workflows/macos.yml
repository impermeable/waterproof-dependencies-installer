# Main doc: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/introduction-to-github-actions
# Runners spec: https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners
# Glob expressions: https://github.com/actions/toolkit/tree/main/packages/glob

name: MacOS

###############################################################################
# Schedule:
# Push on main branch
###############################################################################
on:
  push:
    branches:
      - 8.17-macos
  pull_request:
  workflow_dispatch:

###############################################################################
# Platform script options shared among all jobs
###############################################################################
env:
  COQREGTESTING: y

###############################################################################
# Builds Windows installer
###############################################################################
jobs:
  MacOS_platform:
    name: MacOS
    runs-on: macos-latest
    strategy:
      fail-fast: false
      # matrix:

    steps:
      - name: Set git to use LF
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Git checkout install scripts
        uses: actions/checkout@v2
        with:
          path: main
          ref: 8.17-macos

      - name: Git checkout Coq platform
        uses: actions/checkout@v2
        with:
          repository: coq/platform
          ref: '2023.03.0'
          path: platform
      
      #Testing to see the file layout on macos
      # - name: Test
      #   shell: bash
      #   run: |
      #     ls
      #     cd platform
      #     ls
      #     cd package_picks
      #     ls

      # I believe the macos-latest image comes with xcode installed, uncomment if not
      # - name: Install XCode
      #   run: |
      #     xcode-select --install

      # I believe the macos-latest image comes with homebrew installed, uncomment if not
      # - name: Install HomeBrew
      #   run: |
      #     /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      
      # Is this action necessary?
      - name: Install Bash 4 and GNU sed on Mac
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew update
      
          brew install bash
          brew install gnu-sed
      
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "$(brew --prefix)/opt/gnu-sed/libexec/gnubin" >> $GITHUB_PATH

      - name: Set switch name in coq platform
        shell: bash
        run: |
          sed -i '$a\COQ_PLATFORM_SWITCH_NAME=wp' platform/package_picks/coq_platform_switch_name.sh
          cat platform/package_picks/coq_platform_switch_name.sh

      - name: Run coq platform make script
        if: always()
        shell: bash
        run: sh platform/coq_platform_make.sh -parallel=p -jobs=2 -compcert=n -extent=i -pick="8.17~2023.08" -set-switch=y

      # Output switch names and try a few to see which one is being set
      - name: Activate switch
        if: always()
        shell: bash
        run: |
          opam switch
          opam switch wp
          opam switch opam switch CP.2023.03.0~8.17~2023.08
          eval $(opam env)
      
      # Create installer with no additional packages for now just as a test
      - name: Create installer
        shell: bash
        run: |
          cd platform
          sh macos/create_installer_macos.sh
          mkdir /usr/local/installer && cp macos_installer/*dmg /usr/local/installer

      # How does signing the installer work now? -sign and -signcert are options for the create installer script

      # - name: Sign the installer
      #   run: |
      #     New-Item -ItemType directory -Path certificate
      #     Set-Content -Path certificate\certificate.txt -Value '${{ secrets.CODE_SIGNING_CERTIFICATE }}'
      #     certutil -decode certificate\certificate.txt certificate\certificate.pfx
      #     & 'C:/Program Files (x86)/Windows Kits/10/bin/10.0.17763.0/x86/signtool.exe' sign /f certificate\certificate.pfx /p '${{ secrets.CODE_SIGNING_CERTIFICATE_PASS }}' C:\installer\*.exe
      #     Remove-Item -Path certificate\*



      - name: 'Upload Artifact'
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: 'MacOS DMG Installer'
          path: /usr/local/installer/*.dmg
          retention-days: 5
